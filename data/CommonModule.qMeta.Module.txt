Процедура РазборАлгоритмов(источник) Экспорт
	ОписатьИсточник(Источник);
КонецПроцедуры


Функция СписокСущностей(ссылка,наименование) Экспорт
	Запрос = новый Запрос("ВЫБРАТЬ
	|	""ПКО"" КАК Тип,
	|	""АлгоритмПередВыгрузкойОбъекта"" КАК Место,
	|	&НеЯвно КАК ВидСвязи,
	|	у.Ссылка КАК Владелец,
	|	NULL КАК ПКС,
	|	&Ссылка КАК ПКО,
	|	&Наименование КАК ИмяПКО
	|ИЗ
	|	Справочник.ПравилаКонвертацииОбъектов КАК у
	|ГДЕ
	|	у.АлгоритмПередВыгрузкойОбъекта ПОДОБНО &ИмяПКО
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	""ПКО"",
	|	""АлгоритмПриВыгрузкеОбъекта"",
	|	&НеЯвно,
	|	у.Ссылка,
	|	NULL,
	|	&Ссылка,
	|	&Наименование
	|ИЗ
	|	Справочник.ПравилаКонвертацииОбъектов КАК у
	|ГДЕ
	|	у.АлгоритмПриВыгрузкеОбъекта ПОДОБНО &ИмяПКО
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	""ПКО"",
	|	""АлгоритмПослеВыгрузкиОбъекта"",
	|	&НеЯвно,
	|	у.Ссылка,
	|	NULL,
	|	&Ссылка,
	|	&Наименование
	|ИЗ
	|	Справочник.ПравилаКонвертацииОбъектов КАК у
	|ГДЕ
	|	у.АлгоритмПослеВыгрузкиОбъекта ПОДОБНО &ИмяПКО
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	""ПКО"",
	|	""АлгоритмПередЗагрузкойОбъекта"",
	|	&НеЯвно,
	|	у.Ссылка,
	|	NULL,
	|	&Ссылка,
	|	&Наименование
	|ИЗ
	|	Справочник.ПравилаКонвертацииОбъектов КАК у
	|ГДЕ
	|	у.АлгоритмПередЗагрузкойОбъекта ПОДОБНО &ИмяПКО
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	""ПКО"",
	|	""АлгоритмПриЗагрузкеОбъекта"",
	|	&НеЯвно,
	|	у.Ссылка,
	|	NULL,
	|	&Ссылка,
	|	&Наименование
	|ИЗ
	|	Справочник.ПравилаКонвертацииОбъектов КАК у
	|ГДЕ
	|	у.АлгоритмПриЗагрузкеОбъекта ПОДОБНО &ИмяПКО
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	""ПКО"",
	|	""АлгоритмПослеЗагрузкиОбъекта"",
	|	&НеЯвно,
	|	у.Ссылка,
	|	NULL,
	|	&Ссылка,
	|	&Наименование
	|ИЗ
	|	Справочник.ПравилаКонвертацииОбъектов КАК у
	|ГДЕ
	|	у.АлгоритмПослеЗагрузкиОбъекта ПОДОБНО &ИмяПКО
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	""ПКО"",
	|	""АлгоритмПоследовательностьПолейПоиска"",
	|	&НеЯвно,
	|	у.Ссылка,
	|	NULL,
	|	&Ссылка,
	|	&Наименование
	|ИЗ
	|	Справочник.ПравилаКонвертацииОбъектов КАК у
	|ГДЕ
	|	у.АлгоритмПоследовательностьПолейПоиска ПОДОБНО &ИмяПКО
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	""ПКО"",
	|	""АлгоритмПослеВыгрузкиОбъектаВФайлОбмена"",
	|	&НеЯвно,
	|	у.Ссылка,
	|	NULL,
	|	&Ссылка,
	|	&Наименование
	|ИЗ
	|	Справочник.ПравилаКонвертацииОбъектов КАК у
	|ГДЕ
	|	у.АлгоритмПослеВыгрузкиОбъектаВФайлОбмена ПОДОБНО &ИмяПКО
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	""ПКС"",
	|	""Явно"",
	|	&Явно,
	|	у.Владелец,
	|	у.Ссылка,
	|	&Ссылка,
	|	&Наименование
	|ИЗ
	|	Справочник.ПравилаКонвертацииСвойств КАК у
	|ГДЕ
	|	у.ПравилоКонвертации = &Ссылка
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	""ПКС"",
	|	""АлгоритмПередВыгрузкойСвойства"",
	|	&НеЯвно,
	|	у.Владелец,
	|	у.Ссылка,
	|	&Ссылка,
	|	&Наименование
	|ИЗ
	|	Справочник.ПравилаКонвертацииСвойств КАК у
	|ГДЕ
	|	у.АлгоритмПередВыгрузкойСвойства ПОДОБНО &ИмяПКО
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	""ПКС"",
	|	""АлгоритмПриВыгрузкеСвойства"",
	|	&НеЯвно,
	|	у.Владелец,
	|	у.Ссылка,
	|	&Ссылка,
	|	&Наименование
	|ИЗ
	|	Справочник.ПравилаКонвертацииСвойств КАК у
	|ГДЕ
	|	у.АлгоритмПриВыгрузкеСвойства ПОДОБНО &ИмяПКО
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	""ПКС"",
	|	""АлгоритмПослеВыгрузкиСвойства"",
	|	&НеЯвно,
	|	у.Владелец,
	|	у.Ссылка,
	|	&Ссылка,
	|	&Наименование
	|ИЗ
	|	Справочник.ПравилаКонвертацииСвойств КАК у
	|ГДЕ
	|	у.АлгоритмПослеВыгрузкиСвойства ПОДОБНО &ИмяПКО
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	""ПКС"",
	|	""АлгоритмПередОбработкойВыгрузки"",
	|	&НеЯвно,
	|	у.Владелец,
	|	у.Ссылка,
	|	&Ссылка,
	|	&Наименование
	|ИЗ
	|	Справочник.ПравилаКонвертацииСвойств КАК у
	|ГДЕ
	|	у.АлгоритмПередОбработкойВыгрузки ПОДОБНО &ИмяПКО
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	""ПКС"",
	|	""АлгоритмПослеОбработкиВыгрузки"",
	|	&НеЯвно,
	|	у.Владелец,
	|	у.Ссылка,
	|	&Ссылка,
	|	&Наименование
	|ИЗ
	|	Справочник.ПравилаКонвертацииСвойств КАК у
	|ГДЕ
	|	у.АлгоритмПослеОбработкиВыгрузки ПОДОБНО &ИмяПКО
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	""ПВД"",
	|	""Явно"",
	|	&Явно,
	|	у.Ссылка,
	|	NULL,
	|	&Ссылка,
	|	&Наименование
	|ИЗ
	|	Справочник.ПравилаВыгрузкиДанных КАК у
	|ГДЕ
	|	у.ПравилоКонвертации = &Ссылка
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	""ПВД"",
	|	""АлгоритмПередОбработкойПравила"",
	|	&НеЯвно,
	|	у.Ссылка,
	|	NULL,
	|	&Ссылка,
	|	&Наименование
	|ИЗ
	|	Справочник.ПравилаВыгрузкиДанных КАК у
	|ГДЕ
	|	у.АлгоритмПередОбработкойПравила ПОДОБНО &ИмяПКО
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	""ПВД"",
	|	""АлгоритмПослеОбработкиПравила"",
	|	&НеЯвно,
	|	у.Ссылка,
	|	NULL,
	|	&Ссылка,
	|	&Наименование
	|ИЗ
	|	Справочник.ПравилаВыгрузкиДанных КАК у
	|ГДЕ
	|	у.АлгоритмПослеОбработкиПравила ПОДОБНО &ИмяПКО
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	""ПВД"",
	|	""АлгоритмПередВыгрузкойОбъекта"",
	|	&НеЯвно,
	|	у.Ссылка,
	|	NULL,
	|	&Ссылка,
	|	&Наименование
	|ИЗ
	|	Справочник.ПравилаВыгрузкиДанных КАК у
	|ГДЕ
	|	у.АлгоритмПередВыгрузкойОбъекта ПОДОБНО &ИмяПКО
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	""ПВД"",
	|	""АлгоритмПослеВыгрузкиОбъекта"",
	|	&НеЯвно,
	|	у.Ссылка,
	|	NULL,
	|	&Ссылка,
	|	&Наименование
	|ИЗ
	|	Справочник.ПравилаВыгрузкиДанных КАК у
	|ГДЕ
	|	у.АлгоритмПослеВыгрузкиОбъекта ПОДОБНО &ИмяПКО");
	
	
	Запрос.Текст = СтрЗаменить(Запрос.Текст,"&ИмяПКО","""%ИмяПКО%=%"""""+СокрЛП(наименование)+"""""%""" );
	Запрос.УстановитьПараметр("Ссылка", ссылка);
	Запрос.УстановитьПараметр("Наименование",наименование );
	Запрос.УстановитьПараметр("Явно", Перечисления.qСвязьПКО.ПКО_ВызываетПоПравилу);
	Запрос.УстановитьПараметр("НеЯвно", Перечисления.qСвязьПКО.ПКО_ВызываетПоИмени);
	возврат Запрос.Выполнить().Выгрузить();
	
КонецФункции


Процедура ОписатьИсточник(Источник)
	
	
	Для каждого х Из СписокСущностей(Источник.ссылка,сокрлп(Источник.Код)) Цикл
		
		запись = РегистрыСведений.qСвязиПКО.СоздатьМенеджерЗаписи();
		запись.Владелец = х.Владелец;
		запись.ПКО = х.ПКО;
		запись.ПКС = х.ПКС;
		запись.ИмяПКО = СокрЛП(Источник.Код);
		
		запись.Место = х.Место;
		запись.ВидСвязи = х.ВидСвязи;
		
		запись.Записать();
	КонецЦикла;
	
КонецПроцедуры


Процедура ОтфильтроватьНаФормеПКО(Форма,Фильтр) Экспорт
	
	Форма.ПравилаКонвертацииОбъектов.Отбор.Ссылка.Использование = Ложь;
	Форма.ПравилаКонвертацииСвойств.Отбор.Ссылка.Использование = Ложь;
	Форма.ПравилаВыгрузкиДанных.Отбор.Ссылка.Использование = Ложь;

	Если Фильтр.Пустая() Тогда
		Возврат;
	КонецЕсли;
	
	ТЗ = СписокСущностей(Фильтр.Ссылка,СокрЛП(фильтр.Код));
	
	массивПКО = Новый СписокЗначений;
	массивПКС = Новый СписокЗначений;
	массивПВД = Новый СписокЗначений;
	
	
	Для каждого х Из ТЗ Цикл
		Если х.Тип = "ПКС" Тогда
			массивПКС.Добавить(х.ПКС);
			массивПКО.Добавить(х.Владелец);
		ИначеЕсли х.Тип = "ПКО" Тогда
			массивПКО.Добавить(х.Владелец);
		Иначе
			массивПВД.Добавить(х.Владелец);
		КонецЕсли;
	КонецЦикла;
	
	Форма.ПравилаКонвертацииОбъектов.Отбор.Ссылка.Использование = Истина;
	Форма.ПравилаКонвертацииСвойств.Отбор.Ссылка.Использование = Истина;
	Форма.ПравилаВыгрузкиДанных.Отбор.Ссылка.Использование = Истина;
	
	Форма.ПравилаКонвертацииОбъектов.Отбор.Ссылка.ВидСравнения=ВидСравнения.ВСписке;
	Форма.ПравилаКонвертацииОбъектов.Отбор.Ссылка.Значение=МассивПКО;
	Форма.ПравилаКонвертацииОбъектов.Отбор.Ссылка.Установить(); 	
	
	Форма.ПравилаКонвертацииСвойств.Отбор.Ссылка.ВидСравнения=ВидСравнения.ВСписке;
	Форма.ПравилаКонвертацииСвойств.Отбор.Ссылка.Значение=МассивПКС;
	Форма.ПравилаКонвертацииСвойств.Отбор.Ссылка.Установить(); 	
	
	Форма.ПравилаВыгрузкиДанных.Отбор.Ссылка.ВидСравнения=ВидСравнения.ВСписке;
	Форма.ПравилаВыгрузкиДанных.Отбор.Ссылка.Значение=массивПВД;
	Форма.ПравилаВыгрузкиДанных.Отбор.Ссылка.Установить(); 	
	
КонецПроцедуры


